# roles/git_keys/tasks/main.yaml

### GIT ###
---
- name: generate ssh key
  openssh_keypair:
    path: /home/pi/.ssh/id_rsa

- name: Read SSH public key to authorize
  ansible.builtin.command: cat /home/pi/.ssh/id_rsa.pub
  register: ssh_pub_key

- name: Ensure git is present
  ansible.builtin.apt:
    name: git
    state: present
  become: true

- name: Authorize key with GitHub
  local_action:
    module: github_key
    name: 'pi-{{ ansible_hostname }}'
    token: '{{ github_access_token }}'
    pubkey: '{{ ssh_pub_key.stdout }}'

- name: Set git config email
  git_config:
    name: user.email
    scope: global
    value: '{{ git_user_email }}'

- name: Set git config username
  git_config:
    name: user.name
    scope: global
    value: '{{ git_user_name }}'
